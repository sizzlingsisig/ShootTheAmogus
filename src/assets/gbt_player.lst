                                      1 ;-------------------------------------------------------------------------------
                                      2 ;
                                      3 ; GBT Player v2.1.3
                                      4 ;
                                      5 ; SPDX-License-Identifier: MIT
                                      6 ;
                                      7 ; Copyright (c) 2009-2020, Antonio Niño Díaz <antonio_nd@outlook.com>
                                      8 ;
                                      9 ;-------------------------------------------------------------------------------
                                     10 
                         0000FF10    11 	.NR10 = 0xFF10
                         0000FF11    12 	.NR11 = 0xFF11
                         0000FF12    13 	.NR12 = 0xFF12
                         0000FF13    14 	.NR13 = 0xFF13
                         0000FF14    15 	.NR14 = 0xFF14
                         0000FF16    16 	.NR21 = 0xFF16
                         0000FF17    17 	.NR22 = 0xFF17
                         0000FF18    18 	.NR23 = 0xFF18
                         0000FF19    19 	.NR24 = 0xFF19
                         0000FF1A    20 	.NR30 = 0xFF1A
                         0000FF1B    21 	.NR31 = 0xFF1B
                         0000FF1C    22 	.NR32 = 0xFF1C
                         0000FF1D    23 	.NR33 = 0xFF1D
                         0000FF1E    24 	.NR34 = 0xFF1E
                         0000FF20    25 	.NR41 = 0xFF20
                         0000FF21    26 	.NR42 = 0xFF21
                         0000FF22    27 	.NR43 = 0xFF22
                         0000FF23    28 	.NR44 = 0xFF23
                         0000FF24    29 	.NR50 = 0xFF24
                         0000FF25    30 	.NR51 = 0xFF25
                         0000FF26    31 	.NR52 = 0xFF26
                                     32 
                                     33 ;-------------------------------------------------------------------------------
                                     34 
                                     35 	.area	_DATA
                                     36 
                                     37 ;-------------------------------------------------------------------------------
                                     38 
    00000000                         39 gbt_playing::
    00000000                         40 	.ds	1
                                     41 
    00000001                         42 gbt_song:: ; pointer to the pointer array
    00000001                         43 	.ds	2
    00000003                         44 gbt_bank:: ; bank with the data
    00000003                         45 	.ds 1
    00000004                         46 gbt_speed:: ; playing speed
    00000004                         47 	.ds 1
                                     48 
                                     49 ; Up to 12 bytes per step are copied here to be handled in bank 1
    00000005                         50 gbt_temp_play_data::
    00000005                         51 	.ds 12
                                     52 
    00000011                         53 gbt_loop_enabled::
    00000011                         54 	.ds 1
    00000012                         55 gbt_ticks_elapsed::
    00000012                         56 	.ds	1
    00000013                         57 gbt_current_step::
    00000013                         58 	.ds	1
    00000014                         59 gbt_current_pattern::
    00000014                         60 	.ds	1
    00000015                         61 gbt_current_step_data_ptr:: ; pointer to next step data
    00000015                         62 	.ds 2
                                     63 
    00000017                         64 gbt_channels_enabled::
    00000017                         65 	.ds	1
                                     66 
    00000018                         67 gbt_pan:: ; Ch 1-4
    00000018                         68 	.ds	4*1
    0000001C                         69 gbt_vol:: ; Ch 1-4
    0000001C                         70 	.ds	4*1
    00000020                         71 gbt_instr:: ; Ch 1-4
    00000020                         72 	.ds	4*1
    00000024                         73 gbt_freq:: ; Ch 1-3
    00000024                         74 	.ds	3*2
                                     75 
    0000002A                         76 gbt_channel3_loaded_instrument:: ; current loaded instrument ($FF if none)
    0000002A                         77 	.ds	1
                                     78 
                                     79 ; Arpeggio -> Ch 1-3
    0000002B                         80 gbt_arpeggio_freq_index::
    0000002B                         81 	.ds 3*3 ; { base index, base index + x, base index + y } * 3
    00000034                         82 gbt_arpeggio_enabled::
    00000034                         83 	.ds 3*1 ; if 0, disabled
    00000037                         84 gbt_arpeggio_tick::
    00000037                         85 	.ds	3*1
                                     86 
                                     87 ; Cut note
    0000003A                         88 gbt_cut_note_tick::
    0000003A                         89 	.ds	4*1 ; If tick == gbt_cut_note_tick, stop note.
                                     90 
                                     91 ; Last step of last pattern this is set to 1
    0000003E                         92 gbt_have_to_stop_next_step::
    0000003E                         93 	.ds 1
                                     94 
    0000003F                         95 gbt_update_pattern_pointers::
    0000003F                         96 	.ds 1 ; set to 1 by jump effects
                                     97 
                                     98 ;-------------------------------------------------------------------------------
                                     99 
                                    100 	.area	_CODE
                                    101 
                                    102 ;-------------------------------------------------------------------------------
                                    103 
    00000000                        104 gbt_get_pattern_ptr:: ; a = pattern number
                                    105 
                                    106 	; loads a pointer to pattern a into gbt_current_step_data_ptr
                                    107 
    00000000 5F               [ 4]  108 	ld	e,a
    00000001 16 00            [ 8]  109 	ld	d,#0
                                    110 
    00000003 FA 03 00         [16]  111 	ld	a,(gbt_bank)
    00000006 EA 00 20         [16]  112 	ld	(#0x2000),a ; MBC1, MBC3, MBC5 - Set bank
                                    113 
    00000009 21 01 00         [12]  114 	ld	hl,#gbt_song
    0000000C 2A               [ 8]  115 	ld	a,(hl+)
    0000000D 6E               [ 8]  116 	ld	l,(hl)
    0000000E 67               [ 4]  117 	ld	h,a
                                    118 
                                    119 	; hl = pointer to list of pointers
                                    120 	; de = pattern number
                                    121 
    0000000F 19               [ 8]  122 	add	hl,de
    00000010 19               [ 8]  123 	add	hl,de
                                    124 
                                    125 	; hl = pointer to pattern a pointer
                                    126 
    00000011 2A               [ 8]  127 	ld	a,(hl+)
    00000012 66               [ 8]  128 	ld	h,(hl)
    00000013 6F               [ 4]  129 	ld	l,a
                                    130 
                                    131 	; hl = pointer to pattern a data
                                    132 
    00000014 7D               [ 4]  133 	ld	a,l
    00000015 EA 15 00         [16]  134 	ld	(gbt_current_step_data_ptr),a
    00000018 7C               [ 4]  135 	ld	a,h
    00000019 EA 16 00         [16]  136 	ld	(gbt_current_step_data_ptr+1),a
                                    137 
    0000001C C9               [16]  138 	ret
                                    139 
                                    140 ;-------------------------------------------------------------------------------
                                    141 
    0000001D                        142 gbt_get_pattern_ptr_banked:: ; a = pattern number
                                    143 
                                    144 	; loads a pointer to pattern a into gbt_current_step_data_ptr
                                    145 
    0000001D 4F               [ 4]  146 	ld	c,a
    0000001E 06 00            [ 8]  147 	ld	b,#0
                                    148 
    00000020 FA 03 00         [16]  149 	ld	a,(gbt_bank)
    00000023 EA 00 20         [16]  150 	ld	(#0x2000),a ; MBC1, MBC3, MBC5 - Set bank
                                    151 
    00000026 21 01 00         [12]  152 	ld	hl,#gbt_song
    00000029 2A               [ 8]  153 	ld	a,(hl+)
    0000002A 6E               [ 8]  154 	ld	l,(hl)
    0000002B 67               [ 4]  155 	ld	h,a
                                    156 
                                    157 	; hl = pointer to list of pointers
                                    158 	; de = pattern number
                                    159 
    0000002C 09               [ 8]  160 	add	hl,bc
    0000002D 09               [ 8]  161 	add	hl,bc
                                    162 
                                    163 	; hl = pointer to pattern a pointer
                                    164 
    0000002E 2A               [ 8]  165 	ld	a,(hl+)
    0000002F 46               [ 8]  166 	ld	b,(hl)
    00000030 B0               [ 4]  167 	or	a,b
    00000031 20 03            [12]  168 	jr	nz,dont_loop$
    00000033 EA 14 00         [16]  169 	ld	(gbt_current_pattern), a ; a = 0
    00000036                        170 dont_loop$:
    00000036 3E 01            [ 8]  171 	ld	a,#0x01
    00000038 EA 00 20         [16]  172 	ld	(#0x2000),a ; MBC1, MBC3, MBC5 - Set bank
                                    173 
    0000003B C9               [16]  174 	ret
                                    175 
                                    176 ;-------------------------------------------------------------------------------
                                    177 
    0000003C                        178 _gbt_play::
                                    179 
    0000003C C5               [16]  180 	push	bc
                                    181 
    0000003D F8 04            [12]  182 	lda	hl,4(sp)
    0000003F 5E               [ 8]  183 	ld	e,(hl)
    00000040 23               [ 8]  184 	inc	hl
    00000041 56               [ 8]  185 	ld	d,(hl)
    00000042 23               [ 8]  186 	inc	hl
    00000043 4E               [ 8]  187 	ld	c,(hl)
    00000044 23               [ 8]  188 	inc hl
    00000045 46               [ 8]  189 	ld	b,(hl)
                                    190 
                                    191 	; de = data
                                    192 	; b = speed , c = bank
                                    193 
    00000046 21 01 00         [12]  194 	ld	hl,#gbt_song
    00000049 72               [ 8]  195 	ld	(hl),d
    0000004A 23               [ 8]  196 	inc	hl
    0000004B 73               [ 8]  197 	ld	(hl),e
                                    198 
    0000004C 79               [ 4]  199 	ld	a,c
    0000004D EA 03 00         [16]  200 	ld	(gbt_bank),a
    00000050 78               [ 4]  201 	ld	a,b
    00000051 EA 04 00         [16]  202 	ld	(gbt_speed),a
                                    203 
    00000054 3E 00            [ 8]  204 	ld	a,#0
    00000056 CD 00 00         [24]  205 	call	gbt_get_pattern_ptr
                                    206 
    00000059 AF               [ 4]  207 	xor	a,a
    0000005A EA 13 00         [16]  208 	ld	(gbt_current_step),a
    0000005D EA 14 00         [16]  209 	ld	(gbt_current_pattern),a
    00000060 EA 12 00         [16]  210 	ld	(gbt_ticks_elapsed),a
    00000063 EA 11 00         [16]  211 	ld	(gbt_loop_enabled),a
    00000066 EA 3E 00         [16]  212 	ld	(gbt_have_to_stop_next_step),a
    00000069 EA 3F 00         [16]  213 	ld	(gbt_update_pattern_pointers),a
                                    214 
    0000006C 3E FF            [ 8]  215 	ld	a,#0xFF
    0000006E EA 2A 00         [16]  216 	ld	(gbt_channel3_loaded_instrument),a
                                    217 
    00000071 3E 0F            [ 8]  218 	ld	a,#0x0F
    00000073 EA 17 00         [16]  219 	ld	(gbt_channels_enabled),a
                                    220 
    00000076 21 18 00         [12]  221 	ld	hl,#gbt_pan
    00000079 3E 11            [ 8]  222 	ld	a,#0x11 ; L and R
    0000007B 22               [ 8]  223 	ld	(hl+),a
    0000007C CB 27            [ 8]  224 	sla	a
    0000007E 22               [ 8]  225 	ld	(hl+),a
    0000007F CB 27            [ 8]  226 	sla	a
    00000081 22               [ 8]  227 	ld	(hl+),a
    00000082 CB 27            [ 8]  228 	sla	a
    00000084 77               [ 8]  229 	ld	(hl),a
                                    230 
    00000085 21 1C 00         [12]  231 	ld	hl,#gbt_vol
    00000088 3E F0            [ 8]  232 	ld	a,#0xF0 ; 100%
    0000008A 22               [ 8]  233 	ld	(hl+),a
    0000008B 22               [ 8]  234 	ld	(hl+),a
    0000008C 3E 20            [ 8]  235 	ld	a,#0x20 ; 100%
    0000008E 22               [ 8]  236 	ld	(hl+),a
    0000008F 3E F0            [ 8]  237 	ld	a,#0xF0 ; 100%
    00000091 22               [ 8]  238 	ld	(hl+),a
                                    239 
    00000092 3E 00            [ 8]  240 	ld	a,#0
                                    241 
    00000094 21 20 00         [12]  242 	ld	hl,#gbt_instr
    00000097 22               [ 8]  243 	ld	(hl+),a
    00000098 22               [ 8]  244 	ld	(hl+),a
    00000099 22               [ 8]  245 	ld	(hl+),a
    0000009A 22               [ 8]  246 	ld	(hl+),a
                                    247 
    0000009B 21 24 00         [12]  248 	ld	hl,#gbt_freq
    0000009E 22               [ 8]  249 	ld	(hl+),a
    0000009F 22               [ 8]  250 	ld	(hl+),a
    000000A0 22               [ 8]  251 	ld	(hl+),a
    000000A1 22               [ 8]  252 	ld	(hl+),a
    000000A2 22               [ 8]  253 	ld	(hl+),a
    000000A3 22               [ 8]  254 	ld	(hl+),a
                                    255 
    000000A4 EA 34 00         [16]  256 	ld	(gbt_arpeggio_enabled+0),a
    000000A7 EA 35 00         [16]  257 	ld	(gbt_arpeggio_enabled+1),a
    000000AA EA 36 00         [16]  258 	ld	(gbt_arpeggio_enabled+2),a
                                    259 
    000000AD 3E FF            [ 8]  260 	ld	a,#0xFF
    000000AF EA 3A 00         [16]  261 	ld	(gbt_cut_note_tick+0),a
    000000B2 EA 3B 00         [16]  262 	ld	(gbt_cut_note_tick+1),a
    000000B5 EA 3C 00         [16]  263 	ld	(gbt_cut_note_tick+2),a
    000000B8 EA 3D 00         [16]  264 	ld	(gbt_cut_note_tick+3),a
                                    265 
    000000BB 3E 80            [ 8]  266 	ld	a,#0x80
    000000BD E0 26            [12]  267 	ldh	(#.NR52),a
    000000BF 3E 00            [ 8]  268 	ld	a,#0x00
    000000C1 E0 25            [12]  269 	ldh	(#.NR51),a
    000000C3 3E 00            [ 8]  270 	ld	a,#0x00 ; 0%
    000000C5 E0 24            [12]  271 	ldh	(#.NR50),a
                                    272 
    000000C7 AF               [ 4]  273 	xor	a,a
    000000C8 E0 10            [12]  274 	ldh	(#.NR10),a
    000000CA E0 11            [12]  275 	ldh	(#.NR11),a
    000000CC E0 12            [12]  276 	ldh	(#.NR12),a
    000000CE E0 13            [12]  277 	ldh	(#.NR13),a
    000000D0 E0 14            [12]  278 	ldh	(#.NR14),a
    000000D2 E0 16            [12]  279 	ldh	(#.NR21),a
    000000D4 E0 17            [12]  280 	ldh	(#.NR22),a
    000000D6 E0 18            [12]  281 	ldh	(#.NR23),a
    000000D8 E0 19            [12]  282 	ldh	(#.NR24),a
    000000DA E0 1A            [12]  283 	ldh	(#.NR30),a
    000000DC E0 1B            [12]  284 	ldh	(#.NR31),a
    000000DE E0 1C            [12]  285 	ldh	(#.NR32),a
    000000E0 E0 1D            [12]  286 	ldh	(#.NR33),a
    000000E2 E0 1E            [12]  287 	ldh	(#.NR34),a
    000000E4 E0 20            [12]  288 	ldh	(#.NR41),a
    000000E6 E0 21            [12]  289 	ldh	(#.NR42),a
    000000E8 E0 22            [12]  290 	ldh	(#.NR43),a
    000000EA E0 23            [12]  291 	ldh	(#.NR44),a
                                    292 
    000000EC 3E 77            [ 8]  293 	ld	a,#0x77 ; 100%
    000000EE E0 24            [12]  294 	ldh	(#.NR50),a
                                    295 
    000000F0 3E 01            [ 8]  296 	ld	a,#0x01
    000000F2 EA 00 00         [16]  297 	ld	(gbt_playing),a
                                    298 
    000000F5 C1               [12]  299 	pop	bc
    000000F6 C9               [16]  300 	ret
                                    301 
                                    302 ;-------------------------------------------------------------------------------
                                    303 
    000000F7                        304 _gbt_pause::
    000000F7 F8 02            [12]  305 	lda	hl,2(sp)
    000000F9 7E               [ 8]  306 	ld	a,(hl)
    000000FA EA 00 00         [16]  307 	ld	(gbt_playing),a
    000000FD B7               [ 4]  308 	or	a
    000000FE 20 04            [12]  309 	jr	nz,.gbt_pause_unmute
                                    310 
                                    311 	; Silence all channels
    00000100 AF               [ 4]  312 	xor	a
    00000101 E0 25            [12]  313 	ldh	(#.NR51),a
                                    314 
    00000103 C9               [16]  315 	ret
                                    316 
    00000104                        317 .gbt_pause_unmute: ; Unmute sound if playback is resumed
                                    318 
                                    319     ; Restore panning status
    00000104 21 18 00         [12]  320 	ld	hl,#gbt_pan
    00000107 2A               [ 8]  321 	ld	a,(hl+)
    00000108 B6               [ 8]  322 	or	a,(hl)
    00000109 23               [ 8]  323 	inc	hl
    0000010A B6               [ 8]  324 	or	a,(hl)
    0000010B 23               [ 8]  325 	inc hl
    0000010C B6               [ 8]  326 	or	a,(hl)
    0000010D EA 25 FF         [16]  327 	ld	(#.NR51),a
                                    328 
    00000110 C9               [16]  329 	ret
                                    330 
                                    331 ;-------------------------------------------------------------------------------
                                    332 
    00000111                        333 _gbt_loop::
    00000111 F8 02            [12]  334 	lda	hl,2(sp)
    00000113 7E               [ 8]  335 	ld	a,(hl)
    00000114 EA 11 00         [16]  336 	ld	(gbt_loop_enabled),a
    00000117 C9               [16]  337 	ret
                                    338 
                                    339 ;-------------------------------------------------------------------------------
                                    340 
    00000118                        341 _gbt_stop::
    00000118 AF               [ 4]  342 	xor	a
    00000119 EA 00 00         [16]  343 	ld	(gbt_playing),a
    0000011C E0 24            [12]  344 	ldh	(#.NR50),a
    0000011E E0 25            [12]  345 	ldh	(#.NR51),a
    00000120 E0 26            [12]  346 	ldh	(#.NR52),a
    00000122 C9               [16]  347 	ret
                                    348 
                                    349 ;-------------------------------------------------------------------------------
                                    350 
    00000123                        351 _gbt_enable_channels::
    00000123 F8 02            [12]  352 	lda	hl,2(sp)
    00000125 7E               [ 8]  353 	ld	a,(hl)
    00000126 EA 17 00         [16]  354 	ld	(gbt_channels_enabled),a
    00000129 C9               [16]  355 	ret
                                    356 
                                    357 ;-------------------------------------------------------------------------------
                                    358 
    0000012A                        359 _gbt_update::
                                    360 
    0000012A C5               [16]  361 	push	bc
                                    362 
                                    363 	; gbt_update has some "ret z" and things like that
                                    364 	; We call it from here to make it easier to mantain both
                                    365 	; RGBDS and GBDK versions.
    0000012B CD 30 01         [24]  366 	call	gbt_update
                                    367 
    0000012E C1               [12]  368 	pop	bc
                                    369 
    0000012F C9               [16]  370 	ret
                                    371 
                                    372 ;-------------------------------------------------------------------------------
                                    373 
    00000130                        374 gbt_update:
                                    375 
    00000130 FA 00 00         [16]  376 	ld	a,(gbt_playing)
    00000133 B7               [ 4]  377 	or	a,a
    00000134 C8               [20]  378 	ret	z ; If not playing, return
                                    379 
                                    380 	; Handle tick counter
                                    381 
    00000135 21 12 00         [12]  382 	ld	hl,#gbt_ticks_elapsed
    00000138 FA 04 00         [16]  383 	ld	a,(gbt_speed) ; a = total ticks
    0000013B 46               [ 8]  384 	ld	b,(hl) ; b = ticks elapsed
    0000013C 04               [ 4]  385 	inc	b
    0000013D 70               [ 8]  386 	ld	(hl),b
    0000013E B8               [ 4]  387 	cp	a,b
    0000013F 28 09            [12]  388 	jr	z,.dontexit
                                    389 
                                    390 	; Tick != Speed, update effects and exit
    00000141 3E 01            [ 8]  391 	ld	a,#0x01
    00000143 EA 00 20         [16]  392 	ld	(#0x2000),a ; MBC1, MBC3, MBC5 - Set bank 1
    00000146 CD 00 00         [24]  393 	call	gbt_update_effects_bank1 ; Call update function in bank 1
                                    394 
    00000149 C9               [16]  395 	ret
                                    396 
    0000014A                        397 .dontexit:
    0000014A 36 00            [12]  398 	ld	(hl),#0x00 ; reset tick counter
                                    399 
                                    400 	; Clear tick-based effects
                                    401 	; ------------------------
                                    402 
    0000014C AF               [ 4]  403 	xor	a,a
    0000014D 21 34 00         [12]  404 	ld	hl,#gbt_arpeggio_enabled ; Disable arpeggio
    00000150 22               [ 8]  405 	ld	(hl+),a
    00000151 22               [ 8]  406 	ld	(hl+),a
    00000152 77               [ 8]  407 	ld	(hl),a
    00000153 3D               [ 4]  408 	dec	a ; a = 0xFF
    00000154 21 3A 00         [12]  409 	ld	hl,#gbt_cut_note_tick ; Disable cut note
    00000157 22               [ 8]  410 	ld	(hl+),a
    00000158 22               [ 8]  411 	ld	(hl+),a
    00000159 22               [ 8]  412 	ld	(hl+),a
    0000015A 77               [ 8]  413 	ld	(hl),a
                                    414 
                                    415 	; Update effects
                                    416 	; --------------
                                    417 
    0000015B 3E 01            [ 8]  418 	ld	a,#0x01
    0000015D EA 00 20         [16]  419 	ld	(#0x2000),a ; MBC1, MBC3, MBC5 - Set bank 1
    00000160 CD 00 00         [24]  420 	call	gbt_update_effects_bank1 ; Call update function in bank 1
                                    421 
                                    422 	; Check if last step
                                    423 	; ------------------
                                    424 
    00000163 FA 3E 00         [16]  425 	ld	a,(gbt_have_to_stop_next_step)
    00000166 B7               [ 4]  426 	or	a,a
    00000167 28 09            [12]  427 	jr	z,.dont_stop
                                    428 
    00000169 CD 18 01         [24]  429 	call	_gbt_stop
    0000016C 3E 00            [ 8]  430 	ld	a,#0
    0000016E EA 3E 00         [16]  431 	ld	(gbt_have_to_stop_next_step),a
    00000171 C9               [16]  432 	ret
                                    433 
    00000172                        434 .dont_stop:
                                    435 
                                    436 	; Get this step data
                                    437 	; ------------------
                                    438 
                                    439 	; Change to bank with song data
                                    440 
    00000172 FA 03 00         [16]  441 	ld	a,(gbt_bank)
    00000175 EA 00 20         [16]  442 	ld	(#0x2000),a ; MBC1, MBC3, MBC5
                                    443 
                                    444 	; Get step data
                                    445 
    00000178 FA 15 00         [16]  446 	ld	a,(gbt_current_step_data_ptr)
    0000017B 6F               [ 4]  447 	ld	l,a
    0000017C FA 16 00         [16]  448 	ld	a,(gbt_current_step_data_ptr+1)
    0000017F 67               [ 4]  449 	ld	h,a ; hl = pointer to data
                                    450 
    00000180 11 05 00         [12]  451 	ld	de,#gbt_temp_play_data
                                    452 
    00000183 06 04            [ 8]  453 	ld	b,#4
    00000185                        454 .copy_loop:	; copy as bytes as needed for this step
                                    455 
    00000185 2A               [ 8]  456 	ld	a,(hl+)
    00000186 12               [ 8]  457 	ld	(de),a
    00000187 13               [ 8]  458 	inc	de
    00000188 CB 7F            [ 8]  459 	bit	7,a
    0000018A 20 06            [12]  460 	jr	nz,.more_bytes
    0000018C CB 77            [ 8]  461 	bit	6,a
    0000018E 28 0C            [12]  462 	jr	z,.no_more_bytes_this_channel
                                    463 
    00000190 18 07            [12]  464 	jr	.one_more_byte
                                    465 
    00000192                        466 .more_bytes:
                                    467 
    00000192 2A               [ 8]  468 	ld	a,(hl+)
    00000193 12               [ 8]  469 	ld	(de),a
    00000194 13               [ 8]  470 	inc	de
    00000195 CB 7F            [ 8]  471 	bit	7,a
    00000197 28 03            [12]  472 	jr	z,.no_more_bytes_this_channel
                                    473 
    00000199                        474 .one_more_byte:
                                    475 
    00000199 2A               [ 8]  476 	ld	a,(hl+)
    0000019A 12               [ 8]  477 	ld	(de),a
    0000019B 13               [ 8]  478 	inc	de
                                    479 
    0000019C                        480 .no_more_bytes_this_channel:
    0000019C 05               [ 4]  481 	dec	b
    0000019D 20 E6            [12]  482 	jr	nz,.copy_loop
                                    483 
    0000019F 7D               [ 4]  484 	ld	a,l
    000001A0 EA 15 00         [16]  485 	ld	(gbt_current_step_data_ptr),a
    000001A3 7C               [ 4]  486 	ld	a,h
    000001A4 EA 16 00         [16]  487 	ld	(gbt_current_step_data_ptr+1),a ; save pointer to data
                                    488 
                                    489 	; Increment step/pattern
                                    490 	; ----------------------
                                    491 
                                    492 	; Increment step
                                    493 
    000001A7 FA 13 00         [16]  494 	ld	a,(gbt_current_step)
    000001AA 3C               [ 4]  495 	inc	a
    000001AB EA 13 00         [16]  496 	ld	(gbt_current_step),a
    000001AE FE 40            [ 8]  497 	cp	a,#64
    000001B0 20 2E            [12]  498 	jr	nz,.dont_increment_pattern
                                    499 
                                    500 	; Increment pattern
                                    501 
    000001B2 3E 00            [ 8]  502 	ld	a,#0
    000001B4 EA 13 00         [16]  503 	ld	(gbt_current_step),a ; Step 0
                                    504 
    000001B7 FA 14 00         [16]  505 	ld	a,(gbt_current_pattern)
    000001BA 3C               [ 4]  506 	inc	a
    000001BB EA 14 00         [16]  507 	ld	(gbt_current_pattern),a
                                    508 
    000001BE CD 00 00         [24]  509 	call	gbt_get_pattern_ptr
                                    510 
    000001C1 FA 15 00         [16]  511 	ld	a,(gbt_current_step_data_ptr)
    000001C4 47               [ 4]  512 	ld	b,a
    000001C5 FA 16 00         [16]  513 	ld	a,(gbt_current_step_data_ptr+1)
    000001C8 B0               [ 4]  514 	or	a,b
    000001C9 20 15            [12]  515 	jr	nz,.not_ended ; if pointer is 0, song has ended
                                    516 
    000001CB FA 11 00         [16]  517 	ld	a,(gbt_loop_enabled)
    000001CE A7               [ 4]  518 	and	a,a
                                    519 
    000001CF 28 0A            [12]  520 	jr	z,.loop_disabled
                                    521 
                                    522 	; If loop is enabled, jump to pattern 0
                                    523 
    000001D1 3E 00            [ 8]  524 	ld	a,#0
    000001D3 EA 14 00         [16]  525 	ld	(gbt_current_pattern),a
                                    526 
    000001D6 CD 00 00         [24]  527 	call	gbt_get_pattern_ptr
                                    528 
    000001D9 18 05            [12]  529 	jr	.end_handling_steps_pattern
                                    530 
    000001DB                        531 .loop_disabled:
                                    532 
                                    533 	; If loop is disabled, stop song
                                    534 	; Stop it next step, if not this step won't be played
                                    535 
    000001DB 3E 01            [ 8]  536 	ld	a,#1
    000001DD EA 3E 00         [16]  537 	ld	(gbt_have_to_stop_next_step),a
                                    538 
    000001E0                        539 .not_ended:
                                    540 
    000001E0                        541 .dont_increment_pattern:
                                    542 
    000001E0                        543 .end_handling_steps_pattern:
                                    544 
    000001E0 3E 01            [ 8]  545 	ld	a,#0x01
    000001E2 EA 00 20         [16]  546 	ld	(#0x2000),a ; MBC1, MBC3, MBC5 - Set bank 1
    000001E5 CD 00 00         [24]  547 	call	gbt_update_bank1 ; Call update function in bank 1
                                    548 
                                    549 	; Check if any effect has changed the pattern or step
                                    550 
    000001E8 FA 3F 00         [16]  551 	ld	a,(gbt_update_pattern_pointers)
    000001EB A7               [ 4]  552 	and	a,a
    000001EC C8               [20]  553 	ret	z
                                    554 	; if any effect has changed the pattern or step, update
                                    555 
    000001ED AF               [ 4]  556 	xor	a,a
    000001EE EA 3F 00         [16]  557 	ld	(gbt_update_pattern_pointers),a ; clear update flag
                                    558 
    000001F1 EA 3E 00         [16]  559 	ld	(gbt_have_to_stop_next_step),a ; clear stop flag
                                    560 
    000001F4 FA 14 00         [16]  561 	ld	a,(gbt_current_pattern)
    000001F7 CD 00 00         [24]  562 	call	gbt_get_pattern_ptr ; set ptr to start of the pattern
                                    563 
                                    564 	; Search the step
                                    565 
                                    566 	; Change to bank with song data
                                    567 
    000001FA FA 03 00         [16]  568 	ld	a,(gbt_bank)
    000001FD EA 00 20         [16]  569 	ld	(#0x2000),a ; MBC1, MBC3, MBC5
                                    570 
    00000200 FA 15 00         [16]  571 	ld	a,(gbt_current_step_data_ptr)
    00000203 6F               [ 4]  572 	ld	l,a
    00000204 FA 16 00         [16]  573 	ld	a,(gbt_current_step_data_ptr+1)
    00000207 67               [ 4]  574 	ld	h,a ; hl = pointer to data
                                    575 
    00000208 FA 13 00         [16]  576 	ld	a,(gbt_current_step)
    0000020B A7               [ 4]  577 	and	a,a
    0000020C C8               [20]  578 	ret	z ; if changing to step 0, exit
                                    579 
    0000020D CB 27            [ 8]  580 	sla	a
    0000020F CB 27            [ 8]  581 	sla	a
    00000211 47               [ 4]  582 	ld	b,a ; b = iterations = step * 4 (number of channels)
    00000212                        583 .next_channel:
                                    584 
    00000212 2A               [ 8]  585 	ld	a,(hl+)
    00000213 CB 7F            [ 8]  586 	bit	7,a
    00000215 20 06            [12]  587 	jr	nz,.next_channel_more_bytes
    00000217 CB 77            [ 8]  588 	bit	6,a
    00000219 28 08            [12]  589 	jr	z,.next_channel_no_more_bytes_this_channel
                                    590 
    0000021B 18 05            [12]  591 	jr	.next_channel_one_more_byte
                                    592 
    0000021D                        593 .next_channel_more_bytes:
                                    594 
    0000021D 2A               [ 8]  595 	ld	a,(hl+)
    0000021E CB 7F            [ 8]  596 	bit	7,a
    00000220 28 01            [12]  597 	jr	z,.next_channel_no_more_bytes_this_channel
                                    598 
    00000222                        599 .next_channel_one_more_byte:
                                    600 
    00000222 2A               [ 8]  601 	ld	a,(hl+)
                                    602 
    00000223                        603 .next_channel_no_more_bytes_this_channel:
    00000223 05               [ 4]  604 	dec	b
    00000224 20 EC            [12]  605 	jr	nz,.next_channel
                                    606 
    00000226 7D               [ 4]  607 	ld	a,l
    00000227 EA 15 00         [16]  608 	ld	(gbt_current_step_data_ptr),a
    0000022A 7C               [ 4]  609 	ld	a,h
    0000022B EA 16 00         [16]  610 	ld	(gbt_current_step_data_ptr+1),a ; save pointer to data
                                    611 
    0000022E C9               [16]  612 	ret
                                    613 
                                    614 ;-------------------------------------------------------------------------------
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (GameBoy)                  Page 1
Hexadecimal [32-Bits]

Symbol Table

    .NR10   =   0000FF10     |     .NR11   =   0000FF11     |     .NR12   =   0000FF12 
    .NR13   =   0000FF13     |     .NR14   =   0000FF14     |     .NR21   =   0000FF16 
    .NR22   =   0000FF17     |     .NR23   =   0000FF18     |     .NR24   =   0000FF19 
    .NR30   =   0000FF1A     |     .NR31   =   0000FF1B     |     .NR32   =   0000FF1C 
    .NR33   =   0000FF1D     |     .NR34   =   0000FF1E     |     .NR41   =   0000FF20 
    .NR42   =   0000FF21     |     .NR43   =   0000FF22     |     .NR44   =   0000FF23 
    .NR50   =   0000FF24     |     .NR51   =   0000FF25     |     .NR52   =   0000FF26 
    .__.$$$.=   00002710 L   |     .__.ABS.=   00000000 G   |     .__.CPU.=   00000000 L
    .__.H$L.=   00000000 L   |   0 .copy_lo    00000185 R   |   0 .dont_in    000001E0 R
  0 .dont_st    00000172 R   |   0 .dontexi    0000014A R   |   0 .end_han    000001E0 R
  0 .gbt_pau    00000104 R   |   0 .loop_di    000001DB R   |   0 .more_by    00000192 R
  0 .next_ch    00000212 R   |   0 .next_ch    0000021D R   |   0 .next_ch    00000223 R
  0 .next_ch    00000222 R   |   0 .no_more    0000019C R   |   0 .not_end    000001E0 R
  0 .one_mor    00000199 R   |   0 _gbt_ena    00000123 GR  |   0 _gbt_loo    00000111 GR
  0 _gbt_pau    000000F7 GR  |   0 _gbt_pla    0000003C GR  |   0 _gbt_sto    00000118 GR
  0 _gbt_upd    0000012A GR  |   0 dont_loo    00000036 R   |   1 gbt_arpe    00000034 GR
  1 gbt_arpe    0000002B GR  |   1 gbt_arpe    00000037 GR  |   1 gbt_bank    00000003 GR
  1 gbt_chan    0000002A GR  |   1 gbt_chan    00000017 GR  |   1 gbt_curr    00000014 GR
  1 gbt_curr    00000013 GR  |   1 gbt_curr    00000015 GR  |   1 gbt_cut_    0000003A GR
  1 gbt_freq    00000024 GR  |   0 gbt_get_    00000000 GR  |   0 gbt_get_    0000001D GR
  1 gbt_have    0000003E GR  |   1 gbt_inst    00000020 GR  |   1 gbt_loop    00000011 GR
  1 gbt_pan     00000018 GR  |   1 gbt_play    00000000 GR  |   1 gbt_song    00000001 GR
  1 gbt_spee    00000004 GR  |   1 gbt_temp    00000005 GR  |   1 gbt_tick    00000012 GR
  0 gbt_upda    00000130 R   |     gbt_upda    ******** GX  |     gbt_upda    ******** GX
  1 gbt_upda    0000003F GR  |   1 gbt_vol     0000001C GR

ASxxxx Assembler V02.00 + NoICE + SDCC mods  (GameBoy)                  Page 2
Hexadecimal [32-Bits]

Area Table

   0 _CODE      size      22F   flags    0
   1 _DATA      size       40   flags    0

